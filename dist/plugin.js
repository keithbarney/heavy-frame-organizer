// Generated by CoffeeScript 2.7.0
(function() {
  var build, bundleUI, compileCoffeeScript, concatenateJavaScript, debounce, debouncedBuild, execSync, fileTimestamps, fs, path, watchFiles;

  fs = require("fs-extra");

  ({execSync} = require("child_process"));

  path = require("path");

  debounce = require("lodash.debounce");

  // Store last file modification timestamps
  fileTimestamps = {};

  // Function to compile all CoffeeScript files
  compileCoffeeScript = function() {
    var error;
    try {
      console.log("Compiling CoffeeScript...");
      execSync("coffee -c -o dist/ src/");
      return console.log("CoffeeScript compiled successfully.");
    } catch (error1) {
      error = error1;
      console.error("‚ùå CoffeeScript compilation failed:", error.message);
      return process.exit(1);
    }
  };

  // Function to bundle UI files
  bundleUI = function() {
    var bundledHtml, css, error, html;
    try {
      console.log("Bundling UI components...");
      execSync("pug src/ui.pug --out dist/");
      console.log("Pug compiled to dist/ui.html");
      execSync("sass src/styles.sass dist/styles.css");
      console.log("SASS compiled to dist/styles.css");
      html = fs.readFileSync("dist/ui.html", "utf8");
      css = fs.readFileSync("dist/styles.css", "utf8");
      bundledHtml = html.replace("</head>", `<style>${css}</style></head>`);
      fs.writeFileSync("dist/ui.html", bundledHtml, "utf8");
      return console.log("Successfully bundled UI into dist/ui.html!");
    } catch (error1) {
      error = error1;
      console.error("‚ùå UI bundling failed:", error.message);
      return process.exit(1);
    }
  };

  // Function to concatenate JavaScript files
  concatenateJavaScript = function() {
    var concatenatedContent, error, jsFiles;
    try {
      console.log("Concatenating JavaScript files...");
      jsFiles = fs.readdirSync("dist").filter(function(file) {
        return file.endsWith(".js") && file !== "plugin.js";
      });
      concatenatedContent = jsFiles.map(function(file) {
        return fs.readFileSync(path.join("dist", file), "utf8");
      }).join("\n");
      fs.writeFileSync("dist/plugin.js", concatenatedContent, "utf8");
      return console.log("JavaScript files concatenated into dist/plugin.js");
    } catch (error1) {
      error = error1;
      console.error("‚ùå JavaScript concatenation failed:", error.message);
      return process.exit(1);
    }
  };

  // Function to perform the full build process
  build = function() {
    console.log("Running full build process...");
    compileCoffeeScript();
    bundleUI();
    concatenateJavaScript();
    return console.log("‚úÖ Build complete.");
  };

  // Initial build
  build();

  // Debounced build function to prevent redundant triggers
  debouncedBuild = debounce(build, 500);

  // Function to watch for file changes in the src directory
  watchFiles = function() {
    console.log("Watching for changes in the src directory... Press Ctrl+C to stop.");
    return fs.watch("src", {
      recursive: true
    }, function(eventType, filename) {
      var error, filePath, modifiedTime, stats;
      if (filename) {
        filePath = path.join("src", filename);
        try {
          stats = fs.statSync(filePath);
          modifiedTime = stats.mtimeMs;
          // Prevent unnecessary rebuilds by checking for actual file content modifications
          if (fileTimestamps[filePath] && fileTimestamps[filePath] === modifiedTime) { // Skip rebuild if the file hasn't actually changed
            return;
          }
          fileTimestamps[filePath] = modifiedTime;
          console.log(`Detected changes in ${filename}. Scheduling rebuild...`);
          return debouncedBuild();
        } catch (error1) {
          error = error1;
          return console.error("‚ùå Error reading file:", error.message);
        }
      }
    });
  };

  watchFiles();

}).call(this);

// Generated by CoffeeScript 2.7.0
(function() {
  // Ensure the UI is properly loaded with an adjustable size
  var loadSpacingValues, organizeFrames;

  figma.showUI(__html__, {
    width: 400,
    height: 400
  });

  // Load previous spacing values from client storage
  loadSpacingValues = function() {
    return Promise.all([figma.clientStorage.getAsync("horizontalSpacing"), figma.clientStorage.getAsync("verticalSpacing")]).then(function([storedHorizontal, storedVertical]) {
      var horizontalSpacing, verticalSpacing;
      horizontalSpacing = storedHorizontal || 0;
      verticalSpacing = storedVertical || 0;
      return figma.ui.postMessage({
        type: "load-spacing",
        horizontalSpacing,
        verticalSpacing
      });
    }).catch(function(error) {
      return console.error("Error loading spacing values:", error);
    });
  };

  loadSpacingValues();

  // Listen for messages from the UI
  figma.ui.onmessage = function(msg) {
    var horizontalSpacing, verticalSpacing;
    console.log("Message received from UI:", msg);
    if ((msg != null ? msg.type : void 0) === "organize-frames") {
      verticalSpacing = parseFloat(msg != null ? msg.verticalSpacing : void 0) || 0;
      horizontalSpacing = parseFloat(msg != null ? msg.horizontalSpacing : void 0) || 0;
      // Save values asynchronously
      Promise.all([
        figma.clientStorage.setAsync("horizontalSpacing",
        horizontalSpacing).catch(function(error) {
          return console.error("Error saving horizontal spacing:",
        error);
        }),
        figma.clientStorage.setAsync("verticalSpacing",
        verticalSpacing).catch(function(error) {
          return console.error("Error saving vertical spacing:",
        error);
        })
      ]);
      return organizeFrames(verticalSpacing, horizontalSpacing);
    }
  };

  // Function to organize Figma elements
  organizeFrames = function(verticalSpacing, horizontalSpacing) {
    var i, j, len, len1, mainComponent, node, ref, ref1, subComponent, subComponents, yOffset;
    console.log("Scanning elements on the Figma page...");
    mainComponent = null;
    subComponents = [];
    ref = figma.currentPage.children;
    // Identify main component & sub-components
    for (i = 0, len = ref.length; i < len; i++) {
      node = ref[i];
      console.log("Checking:", node.name, "Type:", node.type);
      if (node.type === "COMPONENT" || node.type === "COMPONENT_SET") {
        if (node.name.startsWith(".")) {
          subComponents.push(node); // Store sub-components
        } else if (!mainComponent) {
          mainComponent = node; // Set the first non-prefixed component as main
        }
      }
    }
    
    // Move the main component to (0,0)
    if (mainComponent) {
      console.log("Setting main component:", mainComponent.name, "to (0,0)");
      mainComponent.x = 0;
      mainComponent.y = 0;
      // Move sub-components below the main component
      yOffset = mainComponent.y + mainComponent.height + verticalSpacing;
      ref1 = subComponents.sort(function(a, b) {
        return a.name.localeCompare(b.name);
      });
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        subComponent = ref1[j];
        console.log("Moving sub-component:", subComponent.name, "to (0,", yOffset, ")");
        subComponent.x = mainComponent.x; // Keep x aligned with main component
        subComponent.y = yOffset;
        yOffset += subComponent.height + verticalSpacing;
      }
    } else {
      console.log("No main component found. Sub-components will not be moved.");
    }
    // Refresh the Figma UI
    figma.currentPage.selection = mainComponent ? [mainComponent].concat(subComponents) : subComponents;
    figma.viewport.scrollAndZoomIntoView(figma.currentPage.selection);
    console.log("Reorganization complete!");
    figma.notify("Main and sub-components arranged!");
    return figma.closePlugin();
  };

}).call(this);

// Generated by CoffeeScript 2.7.0
(function() {
  document.getElementById("apply").addEventListener("click", function() {
    var horizontalSpacing, ref, ref1, verticalSpacing;
    horizontalSpacing = parseInt((ref = document.getElementById("horizontalSpacing")) != null ? ref.value : void 0, 10) || 0;
    verticalSpacing = parseInt((ref1 = document.getElementById("verticalSpacing")) != null ? ref1.value : void 0, 10) || 0;
    console.log("üì§ Sending to Figma:", {horizontalSpacing, verticalSpacing});
    return parent.postMessage({
      pluginMessage: {
        type: "apply-spacing",
        horizontalSpacing: horizontalSpacing,
        verticalSpacing: verticalSpacing
      }
    }, "*");
  });

}).call(this);
